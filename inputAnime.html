<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>inputAnime</title>
        <style>
            div {text-align: center;}
            .vertical-menu {
                position: relative;
                top: 30px;
                left: 120px;
    			width: 520px;;
				height:150px;
				overflow-y:scroll;
                background-color: skyblue;
                text-align: left;
			}
            div input {margin-top: 30px;}  
            td {
                width: 50px;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script>         
            var request=new XMLHttpRequest;
            var translate=new XMLHttpRequest;
            var lastword_simple="";
            var lastword_tradition="";
            var data;//API回傳的物件
            var name_simple_list=[];//API回傳的簡體字動畫清單
            var name_tradition_list=[]//將簡體字清單改成繁體字清單
            var n;
            var searchResult;//API回傳物件的list
            
            
            function transTotradition()
            {
               
                console.log(name_simple_list);
                var name_simple_string=name_simple_list.join("/");
                    translate.open("GET","https://cors-anywhere.herokuapp.com/https://api.zhconvert.org/convert?converter=Traditional&text="+name_simple_string+"&prettify=1");
                    translate.onload=function()
                    {
                        var reword=this.response;
                        reword=JSON.parse(reword);
                        name_tradition_list=reword.data.text.split("/");
                        console.log(name_tradition_list);  
                        console.log("time");
                        print_search_list();            
                    }
                    translate.send()
                
            }

            function transTosimple()//將輸入的繁體轉成簡體後丟給API
            {
                translate.open("GET","https://cors-anywhere.herokuapp.com/https://api.zhconvert.org/convert?converter=Simplified&text="+lastword_tradition+"&prettify=1");
                translate.onload=function()
                {
                    var reword=this.response;
                    reword=JSON.parse(reword);
                    lastword_simple=(reword.data.text);
                    console.log("traTOsimple");
                    inpu();
                }
                translate.send()
               
            }
            function change()//如果輸入欄位的內容改變觸發
            {
                
                if($("#AnimeName").val()!=lastword_tradition)
                {   
                    console.log("change");
                    lastword_tradition=$("#AnimeName").val();
                    if(lastword_tradition!="")
                        transTosimple();
                    else
                        document.getElementById("searchlist").innerHTML="";
                }
            }
            
            function print_search_list()
            {
                var msg="";
                for(var i=parseInt(0);i<n &&i<10;i++)
                {
                    msg+=" <label><input type='radio' name='select_anime' value='"+i+"' required>"+name_tradition_list[i]+"</label><br>";
                }
                console.log("print");
                document.getElementById("searchlist").innerHTML=msg;
            }
            
            function change_word_style()//從API拿到回傳東西後調整回傳清單   
            {
                searchResult=data.list;
                if(n=searchResult.length);
                    for(var i=parseInt(0);i<n &&i<10;i++)
                        name_simple_list[i]=searchResult[i].name_cn;
                console.log("readyTOtrastra");
                transTotradition()
            }

            function inpu()
            {
                request.open("GET","https://cors-anywhere.herokuapp.com/https://api.bgm.tv/search/subject/"+lastword_simple+"?type=2&responseGroup=small&start=0&max_results=25");
                request.onload = function ()
                {
                    data=JSON.parse(this.response);
                    console.log(data);
                    console.log("getJSON");
                    change_word_style();
                }
                request.send();
            }

            function deleteAnime(word)
            {
                window.alert(word);
                localStorage.removeItem(word);
                print_select_list();
            }

            function get_recommend()
            {
                var userList={};
                var len=localStorage.length;
                for(var i=parseInt(0);i<len;i++)
                {
                    var x=JSON.parse(localStorage.getItem(localStorage.key(i)));
                    console.log(x);
                    userList[parseInt(x.id)]=parseInt(x.score);
                } 
                var test={1:8,840:10,203526:9,214265:10,260467:7,280837:7 };                
                console.log(userList);  
                        $.ajax({
                        method: "POST",
                        url: "https://cors-anywhere.herokuapp.com/http://webdesignprojecttest.great-site.net/response.php",
                        data: JSON.stringify(test),
                        // dataType: "JSON",
                        success: function(res) 
                        {
                            console.log(res);
                        }
                        }).done(function(msg){
                            console.log("Ok");
                        });
            }         

            function print_select_list()
            {  

                var len=localStorage.length;
                var key=[];
                var msg="<tr><td style='width:320px;'>名稱</td><td>評分</td><td>刪除</td></tr>";
                for(var i=parseInt(0);i<len;i++)
                    key[i]=JSON.parse(localStorage.getItem(localStorage.key(i)));
                key.sort(function (a,b) {
                    if(parseInt(a.score)>parseInt(b.score))
                        return  -1;
                    else
                        return 1;
                }
                )
                console.log(key);
                for(var i=parseInt(0);i<key.length;i++)
                {
                    msg+="<tr><td>"+key[i].name+"</td><td>"+key[i].score+"</td><td><button id='"+key[i].name+"'>刪除</button></td></tr>" ;
                }    
                document.getElementById("selectedList").innerHTML=msg;
                $("button").click(function(){
                    var key=this.id;
                    console.log(this);
                    console.log(key);
                    localStorage.removeItem(key);   
                    print_select_list();
                    get_recommend()

                })     
            }
            
            function add()
            {
                var work={};
                var i= $("[name='select_anime']:checked").val();
                work["id"]=searchResult[i].id;
                work["name"]=name_tradition_list[i];
                work["score"]=$("#rank").val();
                localStorage.setItem(name_tradition_list[i],JSON.stringify(work));
                print_select_list();
                get_recommend();    
                console.log(searchResult[i]);   
            }

            function start()
            {
                document.getElementById("add").addEventListener("click",add,false);
                print_select_list();
                var interval=window.setInterval("change()",200);
                           
            }
            window.addEventListener("load",start,false);
        </script>
    </head>
        <body style="background-color: #ffc0cb;">
            <div style="text-align: center;width: 50%;">
                <span style="font-size: 300%;"> 請輸入動畫並且評分!</span>
                <div style="text-align: center;width: 100%;">
                    <form>
                        <label>
                        動畫名稱:   <input type="text" id="AnimeName" >
                        請打分:
                        <select id="rank">
                            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                        </select>
                        <input type="button" id="add" value="加入列表" ><br>
                        <div class="vertical-menu" id="searchlist"></div>
                    </form>
                </div  >
                <table id="selectedList" style="border:3px #0e0101 solid;position: relative;top: 50px;left: 120px;column-width: 200%;background-color: dodgerblue;overflow: scroll;" cellpadding="10" border='1'>
                </table>
            </div>
        </body>
</html>
